<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>大樂透終極版－確定能跑！</title>
<style>
  body {font-family:Microsoft JhengHei,Arial,sans-serif;background:linear-gradient(120deg,#667eea,#764ba2);margin:0;padding:20px 0;min-height:100vh;color:#333;}
  .box {max-width:1250px;margin:auto;background:#fff;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,0.3);overflow:hidden;}
  header {background:#2c3e50;color:white;padding:30px;text-align:center;}
  .tab {display:flex;background:#34495e;}
  .tab button {flex:1;padding:18px;font-size:18px;color:white;background:none;border:none;cursor:pointer;}
  .tab button:hover {background:#465c72;}
  .tab button.active {background:#e74c3c;}
  .content {padding:30px;}
  .upload {border:5px dashed #e74c3c;padding:80px;text-align:center;border-radius:20px;background:#fff5f5;cursor:pointer;font-size:24px;transition:0.3s;}
  .upload:hover {background:#ffe0e0;transform:scale(1.01);}
  .filelist {margin:20px 0;padding:20px;background:#f8f9fa;border-radius:10px;max-height:150px;overflow:auto;font-size:16px;}
  textarea {width:100%;height:300px;padding:20px;font-size:17px;border:2px solid #ddd;border-radius:10px;}
  button.run {padding:18px 60px;font-size:22px;background:#e74c3c;color:white;border:none;border-radius:12px;cursor:pointer;margin-top:20px;}
  button.run:hover {background:#c0392b;}
  table {width:100%;border-collapse:collapse;margin:25px 0;font-size:16px;}
  th {background:#e74c3c;color:white;padding:14px;position:sticky;top:0;}
  td {padding:10px;text-align:center;border:1px solid #ddd;}
  .last7 {background:#f1c40f !important;color:#000;font-weight:bold;}
  .consec {background:#e67e22;color:white;font-weight:bold;}
  .hot {background:#ff6b6b;color:white;}
  .cold {background:#74b9ff;color:white;}
  .set {display:inline-block;margin:12px;padding:20px;background:linear-gradient(45deg,#ffecd2,#fcb69f);border-radius:15px;min-width:320px;box-shadow:0 8px 20px rgba(0,0,0,0.15);}
  .prob {font-size:26px;font-weight:bold;color:#e74c3c;}
</style>
</head>
<body>
<div class="box">
  <header>
    <h1>大樂透 終極四重引擎 2025</h1>
    <p>長期＋近10期＋冷門回補＋連號加成　→　直接給你 6個號碼</p>
  </header>

  <div class="tab">
    <button class="active" onclick="openTab('upload')">上傳CSV（可多檔）</button>
    <button onclick="openTab('manual')">手動貼號碼</button>
  </div>

  <div id="upload" class="content">
    <div class="upload" id="dropZone">
      點擊這裡或直接拖曳多個 CSV 檔案進來
    </div>
    <input type="file" id="fileInput" multiple accept=".csv" style="display:none;">
    <div class="filelist" id="fileList"></div>
    <button class="run" onclick="analyze()">開始分析 → 給我 6個號碼</button>
  </button>
  </div>

  <div id="manual" class="content" style="display:none;">
    <p>每行一期，7個數字（前6個正碼＋最後1個特別號），用空格或逗號皆可</p>
    <textarea id="manualInput" placeholder="例：6 9 15 29 30 48 23"></textarea><br>
    <button class="run" onclick="analyze()">開始分析 → 給我 6個號碼</button>
  </div>

  <div id="result"></div>
  <div id="recommend" style="text-align:center;padding:30px;"></div>
</div>

<script>
let allRecords = [];

function openTab(id) {
  document.querySelectorAll('.content').forEach(e=>e.style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.tab button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
}

// 上傳區
const dropZone = document.getElementById('dropZone');
dropZone.onclick = () => document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange = e => loadFiles(e.target.files);
dropZone.ondragover = e => {e.preventDefault(); dropZone.style.background='#ffe0e0';};
dropZone.ondragleave = () => dropZone.style.background='';
dropZone.ondrop = e => {e.preventDefault(); dropZone.style.background=''; loadFiles(e.dataTransfer.files);};

function loadFiles(fileList) {
  allRecords = [];
  const listDiv = document.getElementById('fileList');
  listDiv.innerHTML = '<strong>載入中…</strong><br>';
  let loaded = 0;

  Array.from(fileList).forEach(file => {
    if (!file.name.endsWith('.csv')) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const added = parseCSV(e.target.result);
      listDiv.innerHTML += `${file.name}　→　${added}期<br>`;
      loaded++;
      if (loaded === fileList.length) {
        listDiv.innerHTML += `<br><b style="color:green;">全部完成！共 ${allRecords.length} 期資料</b>`;
      }
    };
    reader.readAsText(file, 'UTF-8');
  });
}

// 解析 CSV（已修好）
function parseCSV(text) {
  const lines = text.trim().split('\n');
  let count = 0;
  if (text.includes('特別號') || text.includes('獎號1')) {
    const cols = lines[0].split(',');
    const idx6 = cols.findIndex(c => c.includes('獎號6') || c.includes('獎號６'));
    const idxSpec = cols.findIndex(c => c.includes('特別號'));
    for (let i = 1; i < lines.length; i++) {
      const c = lines[i].split(',');
      const six = [];
      for (let j = 0; j < 6; j++) {
        const v = parseInt(c[idx6 - 5 + j]);
        if (v >= 1 && v <= 49) six.push(v);
      }
      const spec = parseInt(c[idxSpec]);
      if (six.length === 6 && spec >= 1 && spec <= 49) {
        allRecords.push([...six, spec]);
        count++;
      }
    }
  }
  return count;
}

// 主分析函式
function analyze() {
  // 如果是手動輸入
  if (allRecords.length === 0) {
    const text = document.getElementById('manualInput').value.trim();
    if (!text) return alert('請先上傳檔案或貼入號碼');
    text.split('\n').forEach(line => {
      const arr = line.split(/[\s,，]+/).map(Number).filter(n => n>=1&&n<=49);
      if (arr.length >= 7) allRecords.push(arr.slice(0,7));
    });
  }

  if (allRecords.length < 10) return alert('資料太少，至少需要10期');

  const n = allRecords.length;
  const freq = Array(50).fill(0);
  const recent = Array(50).fill(0);
  const last7 = allRecords[n-1];

  // 1. 長期出現次數
  allRecords.forEach(set => set.forEach(x => freq[x]++));

  // 2. 近10期指數加權
  for (let i = 0; i < Math.min(10, n); i++) {
    const weight = Math.pow(1.6, 9-i);
    allRecords[n-1-i].forEach(x => recent[x] += weight);
  }

  // 3. 冷門回補
  const avg = n*7/49;
  const coldBoost = Array(50).fill(1);
  for (let i=1;i<=49;i++) {
    if (freq[i] <= avg*0.5) {
      let absent = 0;
      for (let j=0;j<Math.min(20,n);j++) {
        if (!allRecords[n-1-j].includes(i)) absent++;
        else break;
      }
      if (absent>=15) coldBoost[i]=3.8;
      else if (absent>=10) coldBoost[i]=2.5;
      else if (absent>=6) coldBoost[i]=1.6;
    }
  }

  // 4. 連號加成
  const consecBonus = Array(50).fill(1);
  for (let i=1;i<n;i++) {
    const prev = allRecords[i-1].slice(0,6).sort((a,b)=>a-b);
    let hasConsec = false;
    for (let j=0;j<5;j++) if (prev[j+1]===prev[j]+1) {hasConsec=true;break;}
    if (hasConsec) {
      allRecords[i].slice(0,6).forEach(num => {
        if (Math.abs(num - (allRecords[i].find(x=>Math.abs(x-num)===1)||0))===1) consecBonus[num] += 0.9;
      });
    }
  }

  // 最終四重分數
  const score = Array(50).fill(0);
  for (let i=1;i<=49;i++) {
    score[i] = freq[i]*0.35 + recent[i]*0.35 + coldBoost[i]*15 + consecBonus[i]*12;
    if (last7.includes(i)) score[i] *= 2.1;  // 上期7碼加倍
  }

  // 正規化成機率
  const totalScore = score.slice(1).reduce((a,b)=>a+b,0);
  const prob = score.map(s => (s/totalScore*100).toFixed(2));

  // 畫統計表
  let table = `<h2>共 ${n} 期 四重複合分析結果</h2>
    <p>上期7碼（黃底）：${last7.join(' ')}　特別號 ${last7[6]}</p>
    <table><tr>
      <th>號碼</th><th>總出現</th><th>近10期權重</th><th>冷門回補</th><th>連號加成</th><th>上期7碼</th><th>最終預測機率</th>
    </tr>`;
  for(let i=1;i<=49;i++){
    let cls = '';
    if(last7.includes(i)) cls='last7';
    else if(consecBonus[i]>2) cls='consec';
    table += `<tr class="${cls}">
      <td><b>${i.toString().padStart(2,'0')}</b></td>
      <td>${freq[i]}</td>
      <td>${recent[i].toFixed(1)}</td>
      <td>${coldBoost[i].toFixed(1)}×</td>
      <td>${consecBonus[i].toFixed(1)}×</td>
      <td>${last7.includes(i)?'●':''}</td>
      <td class="prob">${prob[i]}%</td>
    </tr>`;
  }
  table += '</table>';
  document.getElementById('result').innerHTML = table;

  // 推薦 12組 6個號碼
  let rec = `<h2>第 ${n+1} 期　推薦 12 組 6個號碼</h2>`;
  for(let i=1;i<=12;i++){
    const six = weightedSix(score);
    rec += `<div class="set"><strong>推薦 ${i.toString().padStart(2)}</strong><br>${six.join('　')}</div>`;
  }
  document.getElementById('recommend').innerHTML = rec;
}

// 加權隨機挑6個（不放回）
function weightedSix(weights){
  let pool = [];
  for(let i=1;i<weights.length;i++){
    for(let j=0;j<weights[i]*100;j++) pool.push(i);
  }
  const result = [];
  while(result.length<6 && pool.length>0){
    const idx = Math.floor(Math.random()*pool.length);
    const num = pool[idx];
    if(!result.includes(num)) result.push(num);
    pool.splice(idx,1);
  }
  return result.sort((a,b)=>a-b);
}
</script>
</body>
</html>
